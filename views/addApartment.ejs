<!-- Incluye el encabezado de la página desde un archivo parcial -->
<%- include("partials/header") %>

<!-- Incluye mensajes parciales, como notificaciones o alertas -->
<%- include("partials/mensajes") %>

<!-- Hero section moderno -->
<div class="apartment-form-hero position-relative overflow-hidden">
  <div class="hero-background position-absolute top-0 start-0 w-100 h-100"
       style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
  
  <!-- Partículas animadas de fondo -->
  <div class="particles-container position-absolute top-0 start-0 w-100 h-100">
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
  </div>
  
  <div class="hero-content position-relative py-4">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-8">
          
          <div class="hero-title text-white" style="animation: fadeInLeft 0.8s ease-out;">
            <div class="title-badge mb-3">
              <span class="badge bg-light text-primary px-4 py-2 rounded-pill fs-6 fw-medium">
                <i class="bi bi-plus-circle me-2"></i>Nuevo Apartamento
              </span>
            </div>
            
            <h1 class="display-5 fw-bold mb-3">Crear Apartamento</h1>
            <p class="lead mb-0 text-light">
              Añade una nueva propiedad al catálogo con toda la información necesaria
            </p>
          </div>
        </div>
        
        <div class="col-lg-4 text-center text-lg-end">
          <div class="hero-stats backdrop-blur rounded-4 p-4 shadow-lg border border-light border-opacity-25"
               style="background: rgba(255, 255, 255, 0.1); animation: slideInRight 0.8s ease-out 0.3s both;">
            <div class="stat-item mb-3">
              <div class="stat-icon bg-success bg-gradient rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2"
                   style="width: 50px; height: 50px;">
                <i class="bi bi-house-add text-white fs-4"></i>
              </div>
              <h4 class="text-white fw-bold mb-1">Paso a Paso</h4>
              <p class="text-light small mb-0">Completa todos los campos requeridos</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Contenedor principal del formulario -->
<div class="apartment-form-container py-5" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
  <div class="container">
    <div class="form-wrapper backdrop-blur rounded-4 shadow-lg border border-light border-opacity-50 overflow-hidden"
         style="background: rgba(255, 255, 255, 0.95);">
      
      <!-- Barra de progreso del formulario -->
      <div class="form-progress-bar position-relative">
        <div class="progress-background bg-light" style="height: 6px;"></div>
        <div class="progress-fill bg-gradient position-absolute top-0 start-0 h-100 transition-all"
             style="width: 0%; background: linear-gradient(90deg, #667eea, #764ba2);"></div>
      </div>
      
      <div class="form-content p-5">
        <!-- Título del formulario -->
        <div class="form-header text-center mb-5">
          <h2 class="fw-bold text-dark mb-3" style="animation: fadeInUp 0.8s ease-out;">
            <i class="bi bi-house-add text-primary me-2"></i>
            Nuevo Apartamento
          </h2>
          <p class="text-muted mb-0">Completa todos los campos para crear tu nuevo apartamento</p>
        </div>

        <!-- Formulario para crear apartamento -->
        <form id="apartmentForm" class="needs-validation" method="post" action="/admin/apartment/new" enctype="multipart/form-data" novalidate>
          <input type="hidden" id="photoButtonClicked" name="photoButtonClicked" value="false" />
          
          <!-- Sección 1: Información Básica -->
          <div class="form-section mb-5" data-section="1">
            <div class="section-header d-flex align-items-center mb-4">
              <div class="section-icon bg-primary bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3"
                   style="width: 40px; height: 40px;">
                <i class="bi bi-info-circle text-white"></i>
              </div>
              <div>
                <h4 class="fw-bold text-dark mb-1">Información Básica</h4>
                <p class="text-muted small mb-0">Título y descripción del apartamento</p>
              </div>
            </div>
            
            <div class="row g-4">
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="text" name="title" id="title" class="form-control form-control-lg" 
                         placeholder="Título del apartamento" required>
                  <label for="title">
                    <i class="bi bi-house me-2"></i>Título del apartamento
                  </label>
                  <div class="invalid-feedback">Por favor, ingresa un título.</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <textarea name="description" id="description" class="form-control" 
                            style="height: 120px;" placeholder="Descripción" maxlength="3000" required></textarea>
                  <label for="description">
                    <i class="bi bi-card-text me-2"></i>Descripción
                  </label>
                  <div class="invalid-feedback">Por favor, ingresa una descripción.</div>
                  <div class="form-text">
                    <span id="charCount">0</span>/3000 caracteres
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Sección 2: Normas -->
          <div class="form-section mb-5" data-section="2">
            <div class="section-header d-flex align-items-center mb-4">
              <div class="section-icon bg-warning bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3"
                   style="width: 40px; height: 40px;">
                <i class="bi bi-list-check text-white"></i>
              </div>
              <div>
                <h4 class="fw-bold text-dark mb-1">Normas del Apartamento</h4>
                <p class="text-muted small mb-0">Establece las reglas para los huéspedes</p>
              </div>
            </div>
            
            <div class="rules-container backdrop-blur rounded-3 p-4 border border-light border-opacity-50"
                 style="background: rgba(255, 255, 255, 0.7);">
              <div id="rulesContainer" class="mb-3">
                <!-- Las normas se añadirán dinámicamente aquí -->
              </div>
              <button type="button" class="btn btn-outline-primary rounded-pill px-4" onclick="addRuleField()">
                <i class="bi bi-plus-circle me-2"></i>Añadir norma
              </button>
            </div>
          </div>

          <!-- Sección 3: Detalles del Apartamento -->
          <div class="form-section mb-5" data-section="3">
            <div class="section-header d-flex align-items-center mb-4">
              <div class="section-icon bg-success bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3"
                   style="width: 40px; height: 40px;">
                <i class="bi bi-house-door text-white"></i>
              </div>
              <div>
                <h4 class="fw-bold text-dark mb-1">Detalles del Apartamento</h4>
                <p class="text-muted small mb-0">Habitaciones, camas y características</p>
              </div>
            </div>
            
            <div class="row g-4 mb-4">
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="number" name="rooms" id="rooms" class="form-control" 
                         min="1" placeholder="Habitaciones" required>
                  <label for="rooms">
                    <i class="bi bi-door-open me-2"></i>Número de habitaciones
                  </label>
                  <div class="invalid-feedback">Por favor, ingresa un número válido de habitaciones.</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="number" name="bathrooms" id="bathrooms" class="form-control" 
                         min="1" placeholder="Baños" required>
                  <label for="bathrooms">
                    <i class="bi bi-droplet me-2"></i>Número de baños
                  </label>
                  <div class="invalid-feedback">Por favor, ingresa un número válido de baños.</div>
                </div>
              </div>
            </div>
            
            <!-- Camas por habitación -->
            <div class="beds-section">
              <h6 class="text-muted mb-3">
                <i class="bi bi-bed me-2"></i>Camas por habitación
              </h6>
              <div id="bedsContainer" class="row g-3">
                <!-- Las camas se añadirán dinámicamente aquí -->
              </div>
            </div>
          </div>

          <!-- Sección 4: Fotos -->
          <div class="form-section mb-5" data-section="4">
            <div class="section-header d-flex align-items-center mb-4">
              <div class="section-icon bg-info bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3"
                   style="width: 40px; height: 40px;">
                <i class="bi bi-camera text-white"></i>
              </div>
              <div>
                <h4 class="fw-bold text-dark mb-1">Fotos del Apartamento</h4>
                <p class="text-muted small mb-0">Añade imágenes atractivas de tu propiedad</p>
              </div>
            </div>
            
            <div class="photos-container backdrop-blur rounded-3 p-4 border border-light border-opacity-50"
                 style="background: rgba(255, 255, 255, 0.7);" id="photosGroup">
              <div id="photosContainer" class="row g-3 mb-3">
                <!-- Las fotos se añadirán dinámicamente aquí -->
              </div>
              <button type="button" class="btn btn-outline-primary rounded-pill px-4" id="addPhotoButton" onclick="addNewPhotoField()">
                <i class="bi bi-camera-fill me-2"></i>Añadir foto
              </button>
              <small class="text-danger errorFoto d-block mt-2" style="display: none;">
                Debes añadir al menos una foto
              </small>
            </div>
          </div>

          <!-- Sección 5: Precio y Capacidad -->
          <div class="form-section mb-5" data-section="5">
            <div class="section-header d-flex align-items-center mb-4">
              <div class="section-icon bg-warning bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3"
                   style="width: 40px; height: 40px;">
                <i class="bi bi-currency-euro text-white"></i>
              </div>
              <div>
                <h4 class="fw-bold text-dark mb-1">Precio y Capacidad</h4>
                <p class="text-muted small mb-0">Establece el precio y número máximo de huéspedes</p>
              </div>
            </div>
            
            <div class="row g-4">
              <div class="col-md-4">
                <div class="form-floating">
                  <input type="number" name="price" id="price" class="form-control" 
                         min="0" step="0.01" placeholder="Precio por noche" required>
                  <label for="price">
                    <i class="bi bi-currency-euro me-2"></i>Precio por noche (€)
                  </label>
                  <div class="invalid-feedback">Por favor, ingresa un precio válido.</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <input type="number" name="maxGuests" id="maxGuests" class="form-control" 
                         min="1" placeholder="Máximo de huéspedes" required>
                  <label for="maxGuests">
                    <i class="bi bi-people me-2"></i>Máximo de huéspedes
                  </label>
                  <div class="invalid-feedback">Por favor, ingresa un número válido de huéspedes.</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <input type="number" name="squareMeters" id="squareMeters" class="form-control" 
                         min="1" placeholder="Metros cuadrados" required>
                  <label for="squareMeters">
                    <i class="bi bi-rulers me-2"></i>Metros cuadrados
                  </label>
                  <div class="invalid-feedback">Por favor, ingresa un número válido de metros cuadrados.</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Sección 6: Servicios -->
          <div class="form-section mb-5" data-section="6">
            <div class="section-header d-flex align-items-center mb-4">
              <div class="section-icon bg-info bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3"
                   style="width: 40px; height: 40px;">
                <i class="bi bi-gear text-white"></i>
              </div>
              <div>
                <h4 class="fw-bold text-dark mb-1">Servicios Disponibles</h4>
                <p class="text-muted small mb-0">Selecciona los servicios que ofrece tu apartamento</p>
              </div>
            </div>
            
            <div class="services-container backdrop-blur rounded-3 p-4 border border-light border-opacity-50"
                 style="background: rgba(255, 255, 255, 0.7);">
              <div class="row g-3">
                <% const services = [
                  { id: 'airConditioning', label: 'Aire acondicionado', icon: 'bi bi-snow' },
                  { id: 'heating', label: 'Calefacción', icon: 'bi bi-fire' },
                  { id: 'accessibility', label: 'Accesibilidad', icon: 'bi bi-person-wheelchair' },
                  { id: 'television', label: 'Televisión', icon: 'bi bi-tv' },
                  { id: 'kitchen', label: 'Cocina', icon: 'bi bi-cup-hot' },
                  { id: 'internet', label: 'Internet', icon: 'bi bi-wifi' }
                ]; %>
                <% services.forEach(service => { %>
                  <div class="col-md-4">
                    <div class="service-card card border-0 shadow-sm h-100 transition-all">
                      <div class="card-body text-center p-3">
                        <div class="service-icon mb-2">
                          <i class="<%= service.icon %> fs-2 text-primary"></i>
                        </div>
                        <div class="form-check form-switch d-flex justify-content-center">
                          <input type="checkbox" name="services[<%= service.id %>]" 
                                 class="form-check-input" id="<%= service.id %>">
                          <label class="form-check-label fw-medium" for="<%= service.id %>">
                            <%= service.label %>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                <% }); %>
              </div>
            </div>
          </div>

          <!-- Sección 7: Ubicación -->
          <div class="form-section mb-5" data-section="7">
            <div class="section-header d-flex align-items-center mb-4">
              <div class="section-icon bg-danger bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3"
                   style="width: 40px; height: 40px;">
                <i class="bi bi-geo-alt text-white"></i>
              </div>
              <div>
                <h4 class="fw-bold text-dark mb-1">Ubicación</h4>
                <p class="text-muted small mb-0">Especifica la ubicación exacta del apartamento</p>
              </div>
            </div>
            
            <div class="row g-4">
              <div class="col-md-4">
                <div class="form-floating">
                  <select id="provinceSelect" name="tmpProvince" class="form-select" required>
                    <option value="">-- Selecciona una provincia --</option>
                  </select>
                  <label for="provinceSelect">
                    <i class="bi bi-map me-2"></i>Provincia
                  </label>
                  <div class="invalid-feedback">Por favor, selecciona una provincia.</div>
                  <input type="hidden" name="location[province][id]" id="provinceIdInput">
                  <input type="hidden" name="location[province][nm]" id="provinceNameInput">
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <select id="municipalitySelect" name="tmpCity" class="form-select" required>
                    <option value="">-- Selecciona un municipio --</option>
                  </select>
                  <label for="municipalitySelect">
                    <i class="bi bi-building me-2"></i>Municipio
                  </label>
                  <div class="invalid-feedback">Por favor, selecciona un municipio.</div>
                  <input type="hidden" name="location[municipality][id]" id="municipalityIdInput">
                  <input type="hidden" name="location[municipality][nm]" id="municipalityNameInput">
                </div>
              </div>
              <div class="col-md-2">
                <div class="form-floating">
                  <input type="number" step="any" name="location[gpsCoordinates][lat]" id="lat" class="form-control" 
                         placeholder="Latitud">
                  <label for="lat">
                    <i class="bi bi-crosshair me-2"></i>Latitud (GPS)
                  </label>
                </div>
              </div>
              <div class="col-md-2">
                <div class="form-floating">
                  <input type="number" step="any" name="location[gpsCoordinates][lng]" id="lng" class="form-control" 
                         placeholder="Longitud">
                  <label for="lng">
                    <i class="bi bi-crosshair me-2"></i>Longitud (GPS)
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Campo oculto para el usuario creador -->
          <input type="hidden" name="createdBy" value="<%= currentUser.id %>">

          <!-- Botones de acción -->
          <div class="form-actions d-flex gap-3 justify-content-center mt-5 pt-4 border-top">
            <button type="submit" class="btn btn-primary btn-lg rounded-pill px-5 hover-lift">
              <i class="bi bi-plus-circle me-2"></i>Añadir apartamento
            </button>
            <a href="/admin/dashboard" class="btn btn-outline-secondary btn-lg rounded-pill px-5 hover-lift">
              <i class="bi bi-x-circle me-2"></i>Cancelar
            </a>
          </div>
        </form>

        <!-- Mensaje de error si existe -->
        <% if (typeof error !== 'undefined' && error) { %>
          <div class="alert alert-danger mt-4" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <%= error %>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- Scripts para funcionalidades adicionales -->
<script src="/js/addApartment.js"></script>
<script src="/js/municipiAndProvince.js"></script>

<!-- Estilos CSS personalizados -->
<link rel="stylesheet" href="/css/addApartment.css">

<!-- Incluye el pie de página desde un archivo parcial -->
<%- include("partials/footer") %>
